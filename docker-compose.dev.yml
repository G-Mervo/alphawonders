services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: alphawonders-app
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - CI_ENVIRONMENT=development
      # App
      - app.baseURL=http://localhost:8080/
      - app.forceGlobalSecureRequests=false
      - app.defaultLocale=en
      - app.negotiateLocale=false
      - app.supportedLocales=[en]
      - app.appTimezone=Africa/Nairobi
      - app.charset=UTF-8
      # Database
      - database.default.hostname=postgres
      - database.default.database=alphaw
      - database.default.username=mervo
      - database.default.password=$Tpr09!dKQ-2.0/4(UwZC*7
      - database.default.DBDriver=Postgre
      - database.default.port=5432
      - database.default.DBPrefix=
      - database.default.charset=utf8
      # Email (SMTP)
      - email.fromEmail=${SMTP_FROM_EMAIL:-noreply@alphawonders.com}
      - email.fromName=${SMTP_FROM_NAME:-Alphawonders}
      - email.protocol=smtp
      - email.SMTPHost=${SMTP_HOST:-smtp.gmail.com}
      - email.SMTPUser=${SMTP_USER:-}
      - email.SMTPPass=${SMTP_PASS:-}
      - email.SMTPPort=${SMTP_PORT:-587}
      - email.SMTPCrypto=${SMTP_CRYPTO:-tls}
    volumes:
      - .:/var/www/html
      - app-writable:/var/www/html/writable
      - app-attachments:/var/www/html/attachments
      - ./docker/php.dev.ini:/usr/local/etc/php/conf.d/custom.ini
    networks:
      - shared-services
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres:
    image: postgres:18-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: mervo
      POSTGRES_PASSWORD: "$Tpr09!dKQ-2.0/4(UwZC*7"
      POSTGRES_DB: alphaw
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - shared-services

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@alphawonders.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_LISTEN_PORT: 5050
    ports:
      - "5050:5050"
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    networks:
      - shared-services
    depends_on:
      - postgres

volumes:
  app-writable:
  app-attachments:
  pgdata:
  pgadmin-data:

networks:
  shared-services:
    driver: bridge
